<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Z_eff Visual — Elements + Materials (Fixed)</title>
<style>
  :root{
    --bg:#f4fbfb; --card:#fff; --muted:#6b7280; --accent:#0ea5a4;
    --radius:12px; --shadow:0 12px 36px rgba(9,20,26,0.08);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f8fbfb,#eef8f8);color:#041821}
  .wrap{max-width:1100px;margin:28px auto;padding:18px}
  .topbar{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#0ea5a4,#38bdf8);color:white;padding:10px;border-radius:12px}
  .brand .mark{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .panel{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid rgba(6,25,25,0.04)}
  label{display:block;font-weight:700;margin-bottom:8px;color:#082528}
  select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6eef1;background:#fff;font-size:15px}
  .controls-row{display:flex;gap:10px;align-items:center;margin-top:10px}
  .pill{padding:7px 12px;border-radius:999px;background:#f1fbfa;color:#0b3b36;font-weight:700;font-size:13px}
  .buttons{display:flex;gap:10px;margin-top:14px}
  .btn{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;color:#0a3330;border:1px solid rgba(6,25,25,0.08)}
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
  .stat{background:linear-gradient(180deg,#fcfffe,#f7fdfc);padding:12px;border-radius:10px;font-weight:800;color:#062726;min-height:64px;display:flex;flex-direction:column;justify-content:center}
  .stat small{font-weight:700;color:var(--muted);font-size:12px}
  .swatch{margin-top:16px;border-radius:12px;border:1px solid rgba(6,25,25,0.06);height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:900;font-size:20px;text-align:center;padding:12px;transition:background .14s linear,color .14s linear}
  .swatch .band{font-size:15px;opacity:.95}
  .swatch .zeff{font-size:28px;margin-top:6px}
  .help h3{margin:0 0 8px 0;font-size:16px}
  .legend{display:grid;gap:8px;margin-top:12px}
  .legend-item{display:flex;gap:10px;align-items:center}
  .legend-swatch{width:36px;height:20px;border-radius:6px}
  .footer{margin-top:12px;color:var(--muted);font-size:13px}
  @media (max-width:980px){ .layout{grid-template-columns:1fr} .swatch{height:110px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><div class="mark">Z</div><div><strong>Z_eff Visual</strong><div style="font-size:12px;opacity:.9">Elements + Materials</div></div></div>
    </div>

    <div class="layout">
      <!-- LEFT: controls -->
      <section class="panel" aria-labelledby="controls-title">
        <h2 id="controls-title">Pick Element or Material</h2>
        <p style="color:var(--muted);margin-top:6px">Choose an element (pure) <em>or</em> choose a material (compound). Selecting one disables the other to avoid ambiguity.</p>

        <label for="elementSelect">Element (Periodic Table)</label>
        <select id="elementSelect" aria-label="Element select">
          <option value="">— Select element —</option>
        </select>

        <label for="materialSelect" style="margin-top:12px">Material (compounds / proxies)</label>
        <select id="materialSelect" aria-label="Material select">
          <option value="">— Select material —</option>
        </select>

        <div class="controls-row">
          <div id="categoryPill" class="pill">Category: —</div>
          <div style="margin-left:auto;color:var(--muted);font-size:13px">Tip: select one dropdown at a time</div>
        </div>

        <label for="customFormula" style="margin-top:12px">Custom formula (enable by choosing "Custom Formula" in Materials)</label>
        <input id="customFormula" placeholder="e.g. C7H5N3O6" disabled />

        <div class="buttons">
          <button id="calcBtn" class="btn">Calculate</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>

        <div class="stats" aria-live="polite">
          <div class="stat"><small>Interpreted formula</small><span id="outFormula">—</span></div>
          <div class="stat"><small>Molar mass (g/mol)</small><span id="outMass">—</span></div>
        </div>

        <div id="swatch" class="swatch" role="img" aria-label="Color preview">
          <div class="band">Band</div>
          <div class="zeff">Z_eff ≈ —</div>
        </div>

        <div class="footer" id="explain">Select element or material and press Calculate.</div>
      </section>

      <!-- RIGHT: legend/help -->
      <aside class="panel help" aria-labelledby="help-title">
        <h3 id="help-title">Legend (derived from image)</h3>
        <div class="legend">
          <div class="legend-item"><div class="legend-swatch" style="background:rgb(250,204,21)"></div><div><strong>0–10</strong> — Organic</div></div>
          <div class="legend-item"><div class="legend-swatch" style="background:rgb(16,185,129)"></div><div><strong>11–18</strong> — Inorganic</div></div>
          <div class="legend-item"><div class="legend-swatch" style="background:rgb(59,130,246)"></div><div><strong>19–56</strong> — Metals</div></div>
          <div class="legend-item"><div class="legend-swatch" style="background:rgb(0,0,0)"></div><div><strong>57+</strong> — X-rays Blocked</div></div>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:13px">
          Rule: within a band we interpolate from a light tint (lower Z) to the band base (higher Z). Text color auto-contrasts for readability.
        </div>
      </aside>
    </div>
  </div>

<script>
/* ---------- Periodic table (1–118) ---------- */
const PERIODIC = [
  {Z:1,s:"H", n:"Hydrogen", A:1.008},{Z:2,s:"He", n:"Helium", A:4.0026},{Z:3,s:"Li", n:"Lithium", A:6.94},
  {Z:4,s:"Be", n:"Beryllium", A:9.0122},{Z:5,s:"B", n:"Boron", A:10.81},{Z:6,s:"C", n:"Carbon", A:12.011},
  {Z:7,s:"N", n:"Nitrogen", A:14.007},{Z:8,s:"O", n:"Oxygen", A:15.999},{Z:9,s:"F", n:"Fluorine", A:18.998},
  {Z:10,s:"Ne", n:"Neon", A:20.180},{Z:11,s:"Na", n:"Sodium", A:22.990},{Z:12,s:"Mg", n:"Magnesium", A:24.305},
  {Z:13,s:"Al", n:"Aluminium", A:26.982},{Z:14,s:"Si", n:"Silicon", A:28.085},{Z:15,s:"P", n:"Phosphorus", A:30.974},
  {Z:16,s:"S", n:"Sulfur", A:32.06},{Z:17,s:"Cl", n:"Chlorine", A:35.45},{Z:18,s:"Ar", n:"Argon", A:39.948},
  {Z:19,s:"K", n:"Potassium", A:39.098},{Z:20,s:"Ca", n:"Calcium", A:40.078},{Z:21,s:"Sc", n:"Scandium", A:44.956},
  {Z:22,s:"Ti", n:"Titanium", A:47.867},{Z:23,s:"V", n:"Vanadium", A:50.942},{Z:24,s:"Cr", n:"Chromium", A:51.996},
  {Z:25,s:"Mn", n:"Manganese", A:54.938},{Z:26,s:"Fe", n:"Iron", A:55.845},{Z:27,s:"Co", n:"Cobalt", A:58.933},
  {Z:28,s:"Ni", n:"Nickel", A:58.693},{Z:29,s:"Cu", n:"Copper", A:63.546},{Z:30,s:"Zn", n:"Zinc", A:65.38},
  {Z:31,s:"Ga", n:"Gallium", A:69.723},{Z:32,s:"Ge", n:"Germanium", A:72.630},{Z:33,s:"As", n:"Arsenic", A:74.922},
  {Z:34,s:"Se", n:"Selenium", A:78.971},{Z:35,s:"Br", n:"Bromine", A:79.904},{Z:36,s:"Kr", n:"Krypton", A:83.798},
  {Z:37,s:"Rb", n:"Rubidium", A:85.468},{Z:38,s:"Sr", n:"Strontium", A:87.62},{Z:39,s:"Y", n:"Yttrium", A:88.906},
  {Z:40,s:"Zr", n:"Zirconium", A:91.224},{Z:41,s:"Nb", n:"Niobium", A:92.906},{Z:42,s:"Mo", n:"Molybdenum", A:95.95},
  {Z:43,s:"Tc", n:"Technetium", A:98},{Z:44,s:"Ru", n:"Ruthenium", A:101.07},{Z:45,s:"Rh", n:"Rhodium", A:102.91},
  {Z:46,s:"Pd", n:"Palladium", A:106.42},{Z:47,s:"Ag", n:"Silver", A:107.87},{Z:48,s:"Cd", n:"Cadmium", A:112.41},
  {Z:49,s:"In", n:"Indium", A:114.82},{Z:50,s:"Sn", n:"Tin", A:118.71},{Z:51,s:"Sb", n:"Antimony", A:121.76},
  {Z:52,s:"Te", n:"Tellurium", A:127.60},{Z:53,s:"I", n:"Iodine", A:126.90},{Z:54,s:"Xe", n:"Xenon", A:131.29},
  {Z:55,s:"Cs", n:"Caesium", A:132.91},{Z:56,s:"Ba", n:"Barium", A:137.33},{Z:57,s:"La", n:"Lanthanum", A:138.91},
  {Z:58,s:"Ce", n:"Cerium", A:140.12},{Z:59,s:"Pr", n:"Praseodymium", A:140.91},{Z:60,s:"Nd", n:"Neodymium", A:144.24},
  {Z:61,s:"Pm", n:"Promethium", A:145},{Z:62,s:"Sm", n:"Samarium", A:150.36},{Z:63,s:"Eu", n:"Europium", A:151.96},
  {Z:64,s:"Gd", n:"Gadolinium", A:157.25},{Z:65,s:"Tb", n:"Terbium", A:158.93},{Z:66,s:"Dy", n:"Dysprosium", A:162.50},
  {Z:67,s:"Ho", n:"Holmium", A:164.93},{Z:68,s:"Er", n:"Erbium", A:167.26},{Z:69,s:"Tm", n:"Thulium", A:168.93},
  {Z:70,s:"Yb", n:"Ytterbium", A:173.05},{Z:71,s:"Lu", n:"Lutetium", A:174.97},{Z:72,s:"Hf", n:"Hafnium", A:178.49},
  {Z:73,s:"Ta", n:"Tantalum", A:180.95},{Z:74,s:"W", n:"Tungsten", A:183.84},{Z:75,s:"Re", n:"Rhenium", A:186.21},
  {Z:76,s:"Os", n:"Osmium", A:190.23},{Z:77,s:"Ir", n:"Iridium", A:192.22},{Z:78,s:"Pt", n:"Platinum", A:195.08},
  {Z:79,s:"Au", n:"Gold", A:196.97},{Z:80,s:"Hg", n:"Mercury", A:200.59},{Z:81,s:"Tl", n:"Thallium", A:204.38},
  {Z:82,s:"Pb", n:"Lead", A:207.2},{Z:83,s:"Bi", n:"Bismuth", A:208.98},{Z:84,s:"Po", n:"Polonium", A:209},
  {Z:85,s:"At", n:"Astatine", A:210},{Z:86,s:"Rn", n:"Radon", A:222},{Z:87,s:"Fr", n:"Francium", A:223},
  {Z:88,s:"Ra", n:"Radium", A:226},{Z:89,s:"Ac", n:"Actinium", A:227},{Z:90,s:"Th", n:"Thorium", A:232.04},
  {Z:91,s:"Pa", n:"Protactinium", A:231.04},{Z:92,s:"U", n:"Uranium", A:238.03},{Z:93,s:"Np", n:"Neptunium", A:237},
  {Z:94,s:"Pu", n:"Plutonium", A:244},{Z:95,s:"Am", n:"Americium", A:243},{Z:96,s:"Cm", n:"Curium", A:247},
  {Z:97,s:"Bk", n:"Berkelium", A:247},{Z:98,s:"Cf", n:"Californium", A:251},{Z:99,s:"Es", n:"Einsteinium", A:252},
  {Z:100,s:"Fm", n:"Fermium", A:257},{Z:101,s:"Md", n:"Mendelevium", A:258},{Z:102,s:"No", n:"Nobelium", A:259},
  {Z:103,s:"Lr", n:"Lawrencium", A:266},{Z:104,s:"Rf", n:"Rutherfordium", A:267},{Z:105,s:"Db", n:"Dubnium", A:268},
  {Z:106,s:"Sg", n:"Seaborgium", A:269},{Z:107,s:"Bh", n:"Bohrium", A:270},{Z:108,s:"Hs", n:"Hassium", A:269},
  {Z:109,s:"Mt", n:"Meitnerium", A:278},{Z:110,s:"Ds", n:"Darmstadtium", A:281},{Z:111,s:"Rg", n:"Roentgenium", A:282},
  {Z:112,s:"Cn", n:"Copernicium", A:285},{Z:113,s:"Nh", n:"Nihonium", A:286},{Z:114,s:"Fl", n:"Flerovium", A:289},
  {Z:115,s:"Mc", n:"Moscovium", A:289},{Z:116,s:"Lv", n:"Livermorium", A:293},{Z:117,s:"Ts", n:"Tennessine", A:294},
  {Z:118,s:"Og", n:"Oganesson", A:294}
];

/* ---------- Compound materials (short list; extendable) ---------- */
const MATERIALS = {
  "custom_formula": {f:"", cat:"Custom"},
  "tnt": {f:"C7H5N3O6", cat:"Explosive"},
  "rdx": {f:"C3H6N6O6", cat:"Explosive"},
  "petn": {f:"C5H8N4O12", cat:"Explosive"},
  "hmx": {f:"C4H8N8O8", cat:"Explosive"},
  "nitroglycerin": {f:"C3H5N3O9", cat:"Explosive"},
  "ammonium_nitrate": {f:"NH4NO3", cat:"Explosive Precursor"},
  "anfo": {f:"NH4NO3", cat:"Explosive Precursor"},
  "kno3": {f:"KNO3", cat:"Explosive Precursor"},
  "water": {f:"H2O", cat:"Household"},
  "cocaine": {f:"C17H21NO4", cat:"Drug proxy"},
  "polystyrene": {f:"C8H8", cat:"Plastic"}
};

/* ---------- Algorithm parameters & color bands ---------- */
const P = 2.94;
const BANDS = [
  {min:0, max:10, name:'Organic', base:[250,204,21], light:[255,236,161]},
  {min:11, max:18, name:'Inorganic', base:[16,185,129], light:[178,241,210]},
  {min:19, max:56, name:'Metals', base:[59,130,246], light:[183,212,252]},
  {min:57, max:9999, name:'X-Rays Blocked', base:[0,0,0], light:[80,80,80]}
];

/* ---------- Helpers ---------- */
function lerp(a,b,t){ return Math.round(a + (b-a)*t); }
function rgbToCss(rgb){ return `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`; }
function toLinear(c){ c = c/255; return c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4); }
function luminance(rgb){ return 0.2126*toLinear(rgb[0]) + 0.7152*toLinear(rgb[1]) + 0.0722*toLinear(rgb[2]); }
function contrastTextColor(rgb){ return luminance(rgb) < 0.35 ? '#ffffff' : '#052226'; }

function mapZtoColor(z){
  for(const band of BANDS){
    if(z >= band.min && z <= band.max){
      const denom = (band.max - band.min) || 1;
      const t = (z - band.min) / denom;
      const r = lerp(band.light[0], band.base[0], t);
      const g = lerp(band.light[1], band.base[1], t);
      const b = lerp(band.light[2], band.base[2], t);
      return {rgb:[r,g,b], css: rgbToCss([r,g,b]), band: band.name, range: `${band.min}–${band.max === 9999 ? '57+' : band.max}`};
    }
  }
  return {rgb:[220,220,220], css:'rgb(220,220,220)', band:'Unknown', range:'—'};
}

/* parse formula C7H5N3O6 (simple, no parentheses) */
function parseFormula(formula){
  const re = /([A-Z][a-z]?)(\d*)/g;
  let m; const out = {};
  while((m = re.exec(formula)) !== null){
    const sym = m[1], cnt = m[2] ? parseInt(m[2],10) : 1;
    out[sym] = (out[sym] || 0) + cnt;
  }
  if(Object.keys(out).length === 0) throw new Error('Cannot parse formula. Use e.g. C7H5N3O6');
  return out;
}

/* build ELEMENTS_DB from PERIODIC for quick lookup */
const ELEMENTS_DB = {};
PERIODIC.forEach(e => ELEMENTS_DB[e.s] = {Z: e.Z, A: e.A, name: e.n});

/* compute Zeff for formula */
function computeZeffFromFormula(formula){
  const fd = parseFormula(formula);
  for(const e of Object.keys(fd)) if(!(e in ELEMENTS_DB)) throw new Error(`Element '${e}' not in database.`);
  let molar = 0;
  for(const [sym,cnt] of Object.entries(fd)) molar += cnt * ELEMENTS_DB[sym].A;
  let sum = 0;
  for(const [sym,cnt] of Object.entries(fd)){
    const w = (cnt * ELEMENTS_DB[sym].A) / molar;
    sum += w * Math.pow(ELEMENTS_DB[sym].Z, P);
  }
  const zeff = Math.pow(sum, 1.0 / P);
  return {molar, zeff};
}

/* Title-case helper (with acronyms) */
const ACRONYMS = {'tnt':'TNT','rdx':'RDX','c4':'C4','petn':'PETN','hmx':'HMX','egdn':'EGDN'};
function titleCaseLabel(key){
  if(ACRONYMS[key]) return ACRONYMS[key];
  return key.replace(/_/g,' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

/* ---------- DOM refs ---------- */
const elSelect = document.getElementById('elementSelect');
const matSelect = document.getElementById('materialSelect');
const customFormula = document.getElementById('customFormula');
const calcBtn = document.getElementById('calcBtn');
const clearBtn = document.getElementById('clearBtn');
const outFormula = document.getElementById('outFormula');
const outMass = document.getElementById('outMass');
const swatch = document.getElementById('swatch');
const bandEl = swatch.querySelector('.band');
const zeffEl = swatch.querySelector('.zeff');
const explain = document.getElementById('explain');
const pill = document.getElementById('categoryPill');

/* populate elements dropdown with placeholder + rows */
(function populateElements(){
  PERIODIC.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e.s; // symbol
    opt.text = `${e.Z} — ${e.n}`; // visible label
    opt.title = `${e.s} • Z=${e.Z} • A=${e.A}`;
    elSelect.appendChild(opt);
  });
})();

/* populate materials dropdown */
(function populateMaterials(){
  const keys = Object.keys(MATERIALS).sort((a,b) => a==='custom_formula' ? -1 : a.localeCompare(b));
  keys.forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.text = k === 'custom_formula' ? 'Custom Formula (Enable Input)' : titleCaseLabel(k);
    opt.title = MATERIALS[k].cat + (MATERIALS[k].f ? ' • ' + MATERIALS[k].f : '');
    matSelect.appendChild(opt);
  });
})();

/* UI: when user makes a real selection in one dropdown, disable the other.
   Using empty-value placeholders allows switching freely.
*/
elSelect.addEventListener('change', ()=>{
  if(elSelect.value){ // real element selected
    matSelect.disabled = true;
    customFormula.disabled = true;
    pill.textContent = 'Category: Element';
  } else {
    matSelect.disabled = false;
    customFormula.disabled = true;
    pill.textContent = 'Category: —';
  }
});

matSelect.addEventListener('change', ()=>{
  if(matSelect.value){ // real material selected
    elSelect.disabled = true;
    if(matSelect.value === 'custom_formula'){
      customFormula.disabled = false;
      customFormula.focus();
      pill.textContent = 'Category: Custom';
    } else {
      customFormula.disabled = true;
      pill.textContent = 'Category: ' + (MATERIALS[matSelect.value].cat || '—');
    }
  } else {
    elSelect.disabled = false;
    customFormula.disabled = true;
    pill.textContent = 'Category: —';
  }
});

/* Calculate button: handle either element or material */
calcBtn.addEventListener('click', ()=>{
  // element path
  if(elSelect.value && !elSelect.disabled){
    const sym = elSelect.value;
    const e = ELEMENTS_DB[sym];
    if(!e){ alert('Element data not found'); return; }
    const Z = e.Z;
    outFormula.textContent = sym;
    outMass.textContent = e.A.toFixed(3);
    const col = mapZtoColor(Z);
    swatch.style.background = col.css;
    swatch.style.color = contrastTextColor(col.rgb);
    bandEl.textContent = `${col.band} (${col.range})`;
    zeffEl.textContent = `Z_eff ≈ ${Z.toFixed(3)}`;
    explain.textContent = `${e.n} — Z = ${Z}, A = ${e.A}.`;
    window._last = {type:'element', symbol: sym, name: e.n, Z, A: e.A, band: col.band, color: col.css};
    return;
  }

  // material path
  if(matSelect.value && !matSelect.disabled){
    const key = matSelect.value;
    let formula = MATERIALS[key].f;
    if(key === 'custom_formula'){
      if(!customFormula.value.trim()){ alert('Enter a chemical formula for custom formula'); return; }
      formula = customFormula.value.replace(/\s+/g,'');
    }
    try{
      const res = computeZeffFromFormula(formula);
      outFormula.textContent = formula;
      outMass.textContent = res.molar.toFixed(3);
      const col = mapZtoColor(res.zeff);
      swatch.style.background = col.css;
      swatch.style.color = contrastTextColor(col.rgb);
      bandEl.textContent = `${col.band} (${col.range})`;
      zeffEl.textContent = `Z_eff ≈ ${res.zeff.toFixed(3)}`;
      explain.textContent = `${titleCaseLabel(key)} — formula used: ${formula}.`;
      window._last = {type:'material', key, formula, molar: res.molar, zeff: res.zeff, band: col.band, color: col.css};
    }catch(err){
      alert('Error: ' + err.message);
    }
    return;
  }

  alert('Please select either an Element or a Material (one dropdown only).');
});

/* Clear button resets everything and leaves placeholders in place */
clearBtn.addEventListener('click', ()=>{
  elSelect.value = "";
  matSelect.value = "";
  elSelect.disabled = false;
  matSelect.disabled = false;
  customFormula.value = "";
  customFormula.disabled = true;
  outFormula.textContent = '—';
  outMass.textContent = '—';
  bandEl.textContent = 'Band';
  zeffEl.textContent = 'Z_eff ≈ —';
  swatch.style.background = 'transparent';
  swatch.style.color = '#041821';
  explain.textContent = 'Select element or material and press Calculate.';
  pill.textContent = 'Category: —';
  window._last = null;
});

/* init: nothing selected by default */
document.addEventListener('DOMContentLoaded', ()=>{
  // keep both selects unlocked and placeholder selected
  elSelect.value = "";
  matSelect.value = "";
});
</script>
</body>
</html>
